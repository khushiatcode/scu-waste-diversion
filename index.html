<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Path to Sustainability: Santa Clara University's Waste Diversion Journey</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f9f9f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .chart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 30px;
        }
        .title {
            color: #2C5F2D;
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #555;
            text-align: center;
            margin-bottom: 30px;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            pointer-events: none;
            font-size: 14px;
            max-width: 300px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        .category-toggle {
            display: inline-block;
            margin-right: 15px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 15px;
        }
        .category-toggle.disabled {
            opacity: 0.5;
        }
        .brush .selection {
            stroke: #2C5F2D;
            stroke-opacity: 0.8;
            fill: #2C5F2D;
            fill-opacity: 0.1;
        }
        .milestone {
            font-size: 14px;
            color: #555;
        }
        .milestone-dot {
            stroke: #333;
            stroke-width: 2px;
        }
        .annotation {
            font-size: 12px;
            line-height: 1.4;
        }
        .legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 20px;
            margin-bottom: 10px;
        }
        .legend-color {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-right: 5px;
            border-radius: 3px;
        }
        .metric-box {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 15px;
            text-align: center;
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2C5F2D;
        }
        .metric-label {
            font-size: 1rem;
            color: #666;
        }
        .axis line, .axis path {
            stroke: #ccc;
        }
        .axis text {
            fill: #666;
            font-size: 12px;
        }
        .card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        /* For the Heatmap visualization */
        .heatmap rect {
            stroke: white;
            stroke-width: 1px;
        }
        .heatmap-legend rect {
            stroke: white;
            stroke-width: 1px;
        }
        section {
            margin-bottom: 40px;
        }
        .button {
            background-color: #2C5F2D;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .button:hover {
            background-color: #1a4a1b;
        }
        #downloadSection {
            margin-top: 30px;
            padding: 20px;
            background-color: #f1f8e9;
            border-radius: 8px;
            border: 1px dashed #2C5F2D;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="my-8">
            <h1 class="title text-4xl">The Path to Sustainability: Santa Clara University's Waste Diversion Journey</h1>
            <p class="subtitle text-xl">An interactive exploration of how waste management has evolved from 2005 to 2023</p>
        </header>

        <section>
            <div class="card">
                <p class="mb-4">Santa Clara University's waste management system has undergone significant transformation over the past two decades. What started as primarily a landfill-dependent system has evolved into a multi-stream approach focused on sustainability and diversion. This visualization tells the story of that journey, highlighting key milestones and dramatic improvements in waste diversion practices.</p>
                <p>In 2005, with a diversion rate of only 16.8%, over 2.5 million pounds of waste went to landfill annually. Today, with diversion rates exceeding 68%, SCU has dramatically reduced its environmental impact through expanded recycling, composting, and reuse programs.</p>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="metric-box">
                <div class="metric-value" id="totalDivertedValue">40.5M</div>
                <div class="metric-label">Pounds of Waste Diverted Since 2005</div>
            </div>
            <div class="metric-box">
                <div class="metric-value" id="currentDiversionRate">68.1%</div>
                <div class="metric-label">Current Diversion Rate (2023)</div>
            </div>
            <div class="metric-box">
                <div class="metric-value" id="improvementRate">305%</div>
                <div class="metric-label">Improvement in Diversion Rate</div>
            </div>
        </div>

        <section class="chart-container">
            <h2 class="title text-2xl">Waste Composition Over Time</h2>
            <p class="text-center mb-4">Showing the evolution of waste streams from 2005 to 2023</p>
            
            <div class="legend" id="categoryLegend"></div>
            
            <div class="flex justify-center space-x-4 mb-4" id="categoryToggles"></div>
            
            <div id="mainVisualization"></div>
            <div id="timelineNav" class="mt-4"></div>
            
            <div class="mt-6">
                <p class="text-sm text-gray-600 italic">Note: Click on the legend items to toggle visibility of different waste categories. Drag on the timeline below to zoom into specific time periods.</p>
            </div>
        </section>

        <section class="chart-container">
            <h2 class="title text-2xl">Diversion Rate Progress</h2>
            <p class="text-center mb-4">Tracking SCU's journey toward improved waste diversion</p>
            <div id="diversionChart"></div>
            <div class="mt-4">
                <p class="text-sm text-gray-600">The dramatic increase in diversion rate after 2010 corresponds with the introduction of composting programs, demonstrating the impact of targeted sustainability initiatives.</p>
            </div>
        </section>

        <section class="chart-container">
            <h2 class="title text-2xl">Seasonal Waste Generation Patterns</h2>
            <p class="text-center mb-4">Visualization of waste generation by month and category</p>
            <div id="seasonalPatterns"></div>
            <div class="mt-4">
                <p class="text-sm text-gray-600">This visualization reveals that waste generation during summer break months (May-August) is significantly higher due to multiple factors:<br>
                1) student move-out periods, when large amounts of unwanted items are discarded. <br>
                2) extensive renovation and maintenance work conducted by the university while the campus is less occupied. <br>
                3) summer camps and programs that generate additional waste streams. <br>
                4) bookstore operations that involve processing returned textbooks and stocking new inventory for the upcoming academic year.</p>
            </div>
        </section>

        <section class="card">
            <h2 class="title text-2xl">Key Milestones in SCU's Waste Management Journey</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                <div>
                    <h3 class="font-bold text-lg text-green-800">2010: Composting Program Begins</h3>
                    <p>SCU initiated its first campus-wide composting program, collecting organic waste for the first time. This marked the university's first step beyond basic recycling toward a comprehensive waste diversion strategy.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-green-800">2012: Major Expansion of Composting</h3>
                    <p>A dramatic 434% increase in composting from the previous year, jumping from 192,646 lbs to 1,028,128 lbs annually. This expansion drove the overall diversion rate from 22.9% to 51.9% in a single year.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-green-800">2015: Food Recovery Programs Start</h3>
                    <p>The introduction of the Food Recovery Network and other reuse programs began diverting edible food to hunger relief organizations rather than composting or landfill, adding a social sustainability component to waste management.</p>
                </div>
                <div>
                    <h3 class="font-bold text-lg text-green-800">2016: Enhanced Composting Programs</h3>
                    <p>Specialized collection for food scraps and yard waste began, with detailed tracking of each stream. The diversion rate reached 76.4%.</p>
                </div>
            </div>
        </section>

    </div>

    <script>
        // Data preparation
        const yearlyData = [
            {year: 2005, landfill: 2558210, recycle: 517560, compost: 0, reuse: 0, diversionRate: 16.8},
            {year: 2006, landfill: 2985860, recycle: 478893, compost: 0, reuse: 0, diversionRate: 13.8},
            {year: 2007, landfill: 3133520, recycle: 458119, compost: 0, reuse: 0, diversionRate: 12.8},
            {year: 2008, landfill: 2636120, recycle: 552193, compost: 0, reuse: 0, diversionRate: 17.3},
            {year: 2009, landfill: 2640000, recycle: 494445, compost: 0, reuse: 0, diversionRate: 15.8},
            {year: 2010, landfill: 2345928, recycle: 567558, compost: 151758, reuse: 0, diversionRate: 23.8},
            {year: 2011, landfill: 2518624, recycle: 557113, compost: 192646, reuse: 0, diversionRate: 22.9},
            {year: 2012, landfill: 1704024, recycle: 817995, compost: 1028128, reuse: 0, diversionRate: 51.9},
            {year: 2013, landfill: 1581668, recycle: 948868, compost: 1276248, reuse: 10874, diversionRate: 58.6},
            {year: 2014, landfill: 1601728, recycle: 1102238, compost: 1031208, reuse: 13593, diversionRate: 57.3},
            {year: 2015, landfill: 1318728, recycle: 1181246, compost: 1318516, reuse: 16969, diversionRate: 65.6},
            {year: 2016, landfill: 786549, recycle: 1214574, compost: 1320008, reuse: 13643, diversionRate: 76.4},
            {year: 2017, landfill: 749842, recycle: 1286298, compost: 1306492, reuse: 13160, diversionRate: 77.7},
            {year: 2018, landfill: 818635, recycle: 1190566, compost: 1454070, reuse: 15095, diversionRate: 76.5},
            {year: 2019, landfill: 1024417, recycle: 1022235, compost: 1454410, reuse: 15815, diversionRate: 70.9},
            {year: 2020, landfill: 1150453, recycle: 1050139, compost: 1430980, reuse: 15180, diversionRate: 68.4},
            {year: 2021, landfill: 1154544, recycle: 1095801, compost: 1532442, reuse: 14622, diversionRate: 69.6},
            {year: 2022, landfill: 1260443, recycle: 1128532, compost: 1548144, reuse: 15085, diversionRate: 68.1},
            {year: 2023, landfill: 1289475, recycle: 1165342, compost: 1578305, reuse: 15650, diversionRate: 68.1}
        ];

        // Calculate total waste diverted
        let totalDiverted = 0;
        yearlyData.forEach(d => {
            totalDiverted += d.recycle + d.compost + d.reuse;
        });

        // Format for display
        document.getElementById('totalDivertedValue').textContent = (totalDiverted / 1000000).toFixed(1) + 'M';
        document.getElementById('currentDiversionRate').textContent = yearlyData[yearlyData.length - 1].diversionRate + '%';
        
        // Calculate improvement rate
        const initialRate = yearlyData[0].diversionRate;
        const currentRate = yearlyData[yearlyData.length - 1].diversionRate;
        const improvementRate = ((currentRate - initialRate) / initialRate * 100).toFixed(0);
        document.getElementById('improvementRate').textContent = improvementRate + '%';

        // Define key milestones
        const milestones = [
            {year: 2010, description: "Composting program begins", color: "#2C5F2D"},
            {year: 2012, description: "Major increase in compost", color: "#2C5F2D"},
            {year: 2015, description: "Food recovery programs start", color: "#6A0DAD"},
            {year: 2016, description: "Expanded composting program", color: "#2C5F2D"}
        ];

        // Monthly pattern data for heatmap
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const categories = ["Landfill", "Recycle", "Compost", "Yardwaste"];
        
        // Generate representative seasonal data
        // Values from 1-10 representing intensity of waste generation
        const seasonalData = [
            // January has low waste generation
            {month: "Jan", Landfill: 3, Recycle: 2, Compost: 3, Yardwaste: 1},
            // February has low to moderate waste generation
            {month: "Feb", Landfill: 4, Recycle: 3, Compost: 4, Yardwaste: 2},
            // March has moderate waste generation
            {month: "Mar", Landfill: 5, Recycle: 5, Compost: 5, Yardwaste: 4},
            // April has increasing waste generation
            {month: "Apr", Landfill: 6, Recycle: 6, Compost: 6, Yardwaste: 6},
            // May has high waste generation (move-out period)
            {month: "May", Landfill: 9, Recycle: 8, Compost: 7, Yardwaste: 8},
            // June has peak waste generation (move-out, summer projects)
            {month: "Jun", Landfill: 10, Recycle: 9, Compost: 8, Yardwaste: 9},
            // July has high waste generation (summer maintenance)
            {month: "Jul", Landfill: 8, Recycle: 7, Compost: 7, Yardwaste: 10},
            // August has high waste generation
            {month: "Aug", Landfill: 7, Recycle: 6, Compost: 7, Yardwaste: 9},
            // September has high waste generation (move-in period)
            {month: "Sep", Landfill: 8, Recycle: 9, Compost: 8, Yardwaste: 7},
            // October has moderate to high waste generation
            {month: "Oct", Landfill: 6, Recycle: 7, Compost: 6, Yardwaste: 5},
            // November has moderate waste generation
            {month: "Nov", Landfill: 5, Recycle: 5, Compost: 5, Yardwaste: 3},
            // December has low waste generation (academic break)
            {month: "Dec", Landfill: 2, Recycle: 3, Compost: 2, Yardwaste: 2}
        ];

        // Colors for the different waste categories
        const categoryColors = {
            landfill: "#8B4513", // Brown for landfill
            recycle: "#1E88E5", // Blue for recycling
            compost: "#4CAF50", // Green for compost
            reuse: "#9C27B0" // Purple for reuse
        };

        // ----------------------
        // Main Stacked Area Chart
        // ----------------------
        function createMainVisualization() {
            // Setup dimensions
            const margin = {top: 40, right: 30, bottom: 50, left: 100}; // Increased left margin for y-axis
            const width = 1100 - margin.left - margin.right;
            const height = 500 - margin.top - margin.bottom;

            // Create SVG
            const svg = d3.select("#mainVisualization")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create tooltip
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Setup scales
            const x = d3.scaleLinear()
                .domain(d3.extent(yearlyData, d => d.year))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(yearlyData, d => d.landfill + d.recycle + d.compost + d.reuse)])
                .range([height, 0]);

            // Setup axes
            const xAxis = d3.axisBottom(x)
                .tickFormat(d3.format("d"))
                .ticks(yearlyData.length);
            
            const yAxis = d3.axisLeft(y)
                .tickFormat(d => d3.format(".2s")(d) + " lbs");

            // Add axes
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
            
            // Add axes labels
            svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Year");

            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 30) // Adjusted position to avoid overlap
                .text("Weight (pounds)");

            // Prepare stacked data
            const keys = ["landfill", "recycle", "compost", "reuse"];
            const stack = d3.stack()
                .keys(keys);
            
            // Transform data for stacking
            const stackedData = stack(yearlyData.map(d => ({
                year: d.year,
                landfill: d.landfill,
                recycle: d.recycle,
                compost: d.compost,
                reuse: d.reuse
            })));

            // Track category visibility
            const categoryVisibility = {
                landfill: true,
                recycle: true,
                compost: true,
                reuse: true
            };

            // Create area generator
            const area = d3.area()
                .x(d => x(d.data.year))
                .y0(d => y(d[0]))
                .y1(d => y(d[1]))
                .curve(d3.curveMonotoneX);

            // Add areas
            const areas = svg.selectAll(".area")
                .data(stackedData)
                .enter()
                .append("path")
                .attr("class", d => `area ${d.key}`)
                .attr("fill", d => categoryColors[d.key])
                .attr("d", area)
                .style("opacity", 0.8)
                .on("mouseover", function(event, d) {
                    d3.select(this).style("opacity", 1);
                    
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                })
                .on("mousemove", function(event, d) {
                    // Find the year based on mouse position
                    const xPos = x.invert(d3.pointer(event)[0]);
                    const year = Math.round(xPos);
                    
                    // Find the corresponding data point
                    const dataPoint = yearlyData.find(data => data.year === year);
                    
                    if (dataPoint) {
                        let content = `<strong>Year: ${year}</strong><br>`;
                        
                        if (d.key === "landfill") {
                            content += `<span style="color: ${categoryColors.landfill}">Landfill: ${d3.format(",")(dataPoint.landfill)} lbs</span><br>`;
                        } else if (d.key === "recycle") {
                            content += `<span style="color: ${categoryColors.recycle}">Recycle: ${d3.format(",")(dataPoint.recycle)} lbs</span><br>`;
                        } else if (d.key === "compost") {
                            content += `<span style="color: ${categoryColors.compost}">Compost: ${d3.format(",")(dataPoint.compost)} lbs</span><br>`;
                        } else if (d.key === "reuse") {
                            content += `<span style="color: ${categoryColors.reuse}">Reuse: ${d3.format(",")(dataPoint.reuse)} lbs</span><br>`;
                        }

                        content += `<span>Diversion Rate: ${dataPoint.diversionRate}%</span>`;
                        
                        tooltip.html(content)
                            .style("left", (event.pageX + 10) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    }
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).style("opacity", 0.8);
                    
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add milestone markers
            svg.selectAll(".milestone-dot")
                .data(milestones)
                .enter()
                .append("circle")
                .attr("class", "milestone-dot")
                .attr("cx", d => x(d.year))
                .attr("cy", height)
                .attr("r", 6)
                .attr("fill", d => d.color)
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    
                    tooltip.html(`<strong>${d.year}: ${d.description}</strong>`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add vertical lines for milestones
            svg.selectAll(".milestone-line")
                .data(milestones)
                .enter()
                .append("line")
                .attr("class", "milestone-line")
                .attr("x1", d => x(d.year))
                .attr("y1", 0)
                .attr("x2", d => x(d.year))
                .attr("y2", height)
                .attr("stroke", d => d.color)
                .attr("stroke-width", 1)
                .attr("stroke-dasharray", "5,5")
                .style("opacity", 0.7);

            // Create Legend for categories
            const legendContainer = d3.select("#categoryLegend");
            const legendItems = legendContainer.selectAll(".legend-item")
                .data(keys)
                .enter()
                .append("div")
                .attr("class", "legend-item")
                .style("cursor", "pointer")
                .on("click", function(event, key) {
                    // Toggle visibility
                    categoryVisibility[key] = !categoryVisibility[key];
                    
                    // Update opacity
                    d3.select(this).style("opacity", categoryVisibility[key] ? 1 : 0.5);
                    
                    // Update the chart
                    updateChart();
                });

            legendItems.append("span")
                .attr("class", "legend-color")
                .style("background-color", d => categoryColors[d]);

            legendItems.append("span")
                .text(d => d.charAt(0).toUpperCase() + d.slice(1));

            // Create toggle buttons
            const toggleContainer = d3.select("#categoryToggles");
            const toggleButtons = toggleContainer.selectAll(".category-toggle")
                .data(keys)
                .enter()
                .append("div")
                .attr("class", "category-toggle")
                .style("background-color", d => categoryColors[d])
                .style("color", "white")
                .text(d => d.charAt(0).toUpperCase() + d.slice(1))
                .on("click", function(event, key) {
                    // Toggle visibility
                    categoryVisibility[key] = !categoryVisibility[key];
                    
                    // Update button appearance
                    d3.select(this).classed("disabled", !categoryVisibility[key]);
                    
                    // Update the chart
                    updateChart();
                });

            // Function to update chart based on visibility
            function updateChart() {
                // Filter the keys based on visibility
                const visibleKeys = keys.filter(key => categoryVisibility[key]);
                
                // Update the stack with visible keys
                const newStack = d3.stack().keys(visibleKeys);
                const newStackedData = newStack(yearlyData.map(d => ({
                    year: d.year,
                    landfill: categoryVisibility.landfill ? d.landfill : 0,
                    recycle: categoryVisibility.recycle ? d.recycle : 0,
                    compost: categoryVisibility.compost ? d.compost : 0,
                    reuse: categoryVisibility.reuse ? d.reuse : 0
                })));
                
                // Remove existing areas
                svg.selectAll(".area").remove();
                
                // Add new areas
                svg.selectAll(".area")
                    .data(newStackedData)
                    .enter()
                    .append("path")
                    .attr("class", d => `area ${d.key}`)
                    .attr("fill", d => categoryColors[d.key])
                    .attr("d", area)
                    .style("opacity", 0.8)
                    .on("mouseover", function(event, d) {
                        d3.select(this).style("opacity", 1);
                        
                        tooltip.transition()
                            .duration(200)
                            .style("opacity", 0.9);
                    })
                    .on("mousemove", function(event, d) {
                        // Find the year based on mouse position
                        const xPos = x.invert(d3.pointer(event)[0]);
                        const year = Math.round(xPos);
                        
                        // Find the corresponding data point
                        const dataPoint = yearlyData.find(data => data.year === year);
                        
                        if (dataPoint) {
                            let content = `<strong>Year: ${year}</strong><br>`;
                            
                            if (d.key === "landfill") {
                                content += `<span style="color: ${categoryColors.landfill}">Landfill: ${d3.format(",")(dataPoint.landfill)} lbs</span><br>`;
                            } else if (d.key === "recycle") {
                                content += `<span style="color: ${categoryColors.recycle}">Recycle: ${d3.format(",")(dataPoint.recycle)} lbs</span><br>`;
                            } else if (d.key === "compost") {
                                content += `<span style="color: ${categoryColors.compost}">Compost: ${d3.format(",")(dataPoint.compost)} lbs</span><br>`;
                            } else if (d.key === "reuse") {
                                content += `<span style="color: ${categoryColors.reuse}">Reuse: ${d3.format(",")(dataPoint.reuse)} lbs</span><br>`;
                            }

                            content += `<span>Diversion Rate: ${dataPoint.diversionRate}%</span>`;
                            
                            tooltip.html(content)
                                .style("left", (event.pageX + 10) + "px")
                                .style("top", (event.pageY - 28) + "px");
                        }
                    })
                    .on("mouseout", function(event, d) {
                        d3.select(this).style("opacity", 0.8);
                        
                        tooltip.transition()
                            .duration(500)
                            .style("opacity", 0);
                    });
            }

            // Create the timeline navigation (brush)
            const brushHeight = 50;
            const timeline = d3.select("#timelineNav")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", brushHeight + 20)
                .append("g")
                .attr("transform", `translate(${margin.left},10)`);

            // Create the mini chart for the timeline
            const miniArea = d3.area()
                .x(d => x(d.data.year))
                .y0(brushHeight)
                .y1(d => {
                    const total = d.data.landfill + d.data.recycle + d.data.compost + d.data.reuse;
                    return brushHeight - (total / 6000000) * brushHeight;
                })
                .curve(d3.curveMonotoneX);

            // Create the mini chart path
            timeline.selectAll(".mini-area")
                .data(stackedData)
                .enter()
                .append("path")
                .attr("class", "mini-area")
                .attr("fill", d => categoryColors[d.key])
                .attr("d", miniArea)
                .style("opacity", 0.8);

            // Add brush for timeline navigation - Fixed to handle events properly
            const brush = d3.brushX()
                .extent([[0, 0], [width, brushHeight]])
                .on("end", function(event) {
                    if (!event.selection) return; // Exit if brush selection is empty
                    brushed(event);
                });

            timeline.append("g")
                .attr("class", "brush")
                .call(brush)
                .call(brush.move, x.range());

            function brushed(event) {
                if (!event.selection) return;
                
                const [x0, x1] = event.selection.map(x.invert);
                
                // Update x scale domain based on brush selection
                x.domain([Math.floor(x0), Math.ceil(x1)]);
                
                // Update the x-axis
                svg.select(".x.axis")
                    .transition()
                    .duration(750)
                    .call(xAxis);
                
                // Update the stacked areas
                svg.selectAll(".area")
                    .transition()
                    .duration(750)
                    .attr("d", area);
                
                // Update milestone dots
                svg.selectAll(".milestone-dot")
                    .transition()
                    .duration(750)
                    .attr("cx", d => x(d.year));
                
                // Update milestone lines
                svg.selectAll(".milestone-line")
                    .transition()
                    .duration(750)
                    .attr("x1", d => x(d.year))
                    .attr("x2", d => x(d.year));
            }
        }

        // ----------------------
        // Diversion Rate Chart
        // ----------------------
        function createDiversionChart() {
            // Setup dimensions
            const margin = {top: 30, right: 30, bottom: 50, left: 60};
            const width = 1100 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            // Create SVG
            const svg = d3.select("#diversionChart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create tooltip
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Setup scales
            const x = d3.scaleLinear()
                .domain(d3.extent(yearlyData, d => d.year))
                .range([0, width]);

            const y = d3.scaleLinear()
                .domain([0, 100]) // Diversion rate is a percentage
                .range([height, 0]);

            // Setup axes
            const xAxis = d3.axisBottom(x)
                .tickFormat(d3.format("d"))
                .ticks(yearlyData.length);
            
            const yAxis = d3.axisLeft(y)
                .tickFormat(d => d + "%");

            // Add axes
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);
            
            // Add axes labels
            svg.append("text")
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", width / 2)
                .attr("y", height + margin.bottom - 10)
                .text("Year");

            svg.append("text")
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("transform", "rotate(-90)")
                .attr("x", -height / 2)
                .attr("y", -margin.left + 20)
                .text("Diversion Rate (%)");

            // Line generator
            const line = d3.line()
                .x(d => x(d.year))
                .y(d => y(d.diversionRate))
                .curve(d3.curveMonotoneX);

            // Add line path
            svg.append("path")
                .datum(yearlyData)
                .attr("class", "line")
                .attr("fill", "none")
                .attr("stroke", "#2C5F2D")
                .attr("stroke-width", 3)
                .attr("d", line);

            // Add dots
            svg.selectAll(".dot")
                .data(yearlyData)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("cx", d => x(d.year))
                .attr("cy", d => y(d.diversionRate))
                .attr("r", 5)
                .attr("fill", "#2C5F2D")
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("r", 8);
                    
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    
                    tooltip.html(`<strong>Year: ${d.year}</strong><br>Diversion Rate: ${d.diversionRate}%`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("r", 5);
                    
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add milestone markers to diversion chart
            svg.selectAll(".milestone-dot-div")
                .data(milestones)
                .enter()
                .append("circle")
                .attr("class", "milestone-dot")
                .attr("cx", d => x(d.year))
                .attr("cy", d => {
                    const dataPoint = yearlyData.find(data => data.year === d.year);
                    return y(dataPoint ? dataPoint.diversionRate : 0);
                })
                .attr("r", 6)
                .attr("fill", d => d.color)
                .attr("stroke", "#fff")
                .attr("stroke-width", 2)
                .on("mouseover", function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    
                    const dataPoint = yearlyData.find(data => data.year === d.year);
                    tooltip.html(`<strong>${d.year}: ${d.description}</strong><br>Diversion Rate: ${dataPoint ? dataPoint.diversionRate : 0}%`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });
        }

        // ----------------------
        // Seasonal Pattern Heatmap
        // ----------------------
        function createSeasonalPatternViz() {
            // Setup dimensions
            const margin = {top: 30, right: 80, bottom: 50, left: 60};
            const width = 1100 - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            // Cell dimensions
            const cellWidth = width / months.length;
            const cellHeight = height / categories.length;

            // Create SVG
            const svg = d3.select("#seasonalPatterns")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create tooltip
            const tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Setup color scale for heatmap
            const colorScale = d3.scaleSequential(d3.interpolateYlOrRd)
                .domain([1, 10]); // Min and max values in the data

            // Create legend for heatmap
            const legendWidth = 20;
            const legendHeight = height;

            const legendScale = d3.scaleLinear()
                .domain([1, 10])
                .range([legendHeight, 0]);

            const legendAxis = d3.axisRight(legendScale)
                .tickSize(4)
                .ticks(5);

            const legend = svg.append("g")
                .attr("class", "heatmap-legend")
                .attr("transform", `translate(${width + 20}, 0)`);

            const legendGradient = legend.append("defs")
                .append("linearGradient")
                .attr("id", "legend-gradient")
                .attr("x1", "0%")
                .attr("y1", "100%")
                .attr("x2", "0%")
                .attr("y2", "0%");

            const stops = [
                { offset: "0%", color: colorScale(1) },
                { offset: "20%", color: colorScale(3) },
                { offset: "40%", color: colorScale(5) },
                { offset: "60%", color: colorScale(7) },
                { offset: "80%", color: colorScale(9) },
                { offset: "100%", color: colorScale(10) }
            ];

            legendGradient.selectAll("stop")
                .data(stops)
                .enter().append("stop")
                .attr("offset", d => d.offset)
                .attr("stop-color", d => d.color);

            legend.append("rect")
                .attr("width", legendWidth)
                .attr("height", legendHeight)
                .style("fill", "url(#legend-gradient)");

            legend.append("g")
                .attr("class", "legend-axis")
                .attr("transform", `translate(${legendWidth}, 0)`)
                .call(legendAxis);

            legend.append("text")
                .attr("class", "legend-title")
                .attr("x", legendWidth / 2)
                .attr("y", -10)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text("Intensity");

            // Create heatmap cells
            const cells = svg.selectAll(".cell")
                .data(function() {
                    const heatmapData = [];
                    months.forEach(month => {
                        categories.forEach(category => {
                            const monthData = seasonalData.find(d => d.month === month);
                            if (monthData) {
                                heatmapData.push({
                                    month: month,
                                    category: category,
                                    value: monthData[category]
                                });
                            }
                        });
                    });
                    return heatmapData;
                })
                .enter()
                .append("rect")
                .attr("class", "cell")
                .attr("x", d => months.indexOf(d.month) * cellWidth)
                .attr("y", d => categories.indexOf(d.category) * cellHeight)
                .attr("width", cellWidth)
                .attr("height", cellHeight)
                .attr("fill", d => colorScale(d.value))
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("stroke", "#333").attr("stroke-width", 2);
                    
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", 0.9);
                    
                    let intensity;
                    if (d.value <= 3) intensity = "Low";
                    else if (d.value <= 6) intensity = "Moderate";
                    else intensity = "High";
                    
                    let explanation = "";
                    if (d.month === "May" || d.month === "Jun")
                        explanation = "(Move-out period)";
                    else if (d.month === "Jul" || d.month === "Aug")
                        explanation = "(Maintenance/Construction)";
                    else if (d.month === "Aug" || d.month === "Sep")
                        explanation = "(Move-in period)";
                    else if (d.month === "Dec" || d.month === "Jan")
                        explanation = "(Academic break)";
                    
                    tooltip.html(`<strong>${d.month}: ${d.category}</strong><br>Intensity: ${intensity} ${explanation}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function() {
                    d3.select(this).attr("stroke", "none");
                    
                    tooltip.transition()
                        .duration(500)
                        .style("opacity", 0);
                });

            // Add month labels
            svg.selectAll(".month-label")
                .data(months)
                .enter()
                .append("text")
                .attr("class", "month-label")
                .attr("x", (d, i) => i * cellWidth + cellWidth / 2)
                .attr("y", height + 20)
                .attr("text-anchor", "middle")
                .style("font-size", "12px")
                .text(d => d);

            // Add category labels
            svg.selectAll(".category-label")
                .data(categories)
                .enter()
                .append("text")
                .attr("class", "category-label")
                .attr("x", -5)
                .attr("y", (d, i) => i * cellHeight + cellHeight / 2)
                .attr("text-anchor", "end")
                .attr("alignment-baseline", "middle")
                .style("font-size", "12px")
                .text(d => d);
        }

        // Call the visualization functions
        createMainVisualization();
        createDiversionChart();
        createSeasonalPatternViz();

        // Add the code snippet to the pre element
        document.getElementById('codeSnippet').textContent = document.querySelector('script').textContent;

        // Add copy functionality
        document.getElementById('copyCodeBtn').addEventListener('click', function() {
            const codeSnippet = document.getElementById('codeSnippet').textContent;
            navigator.clipboard.writeText(codeSnippet).then(function() {
                const btn = document.getElementById('copyCodeBtn');
                btn.textContent = 'Copied!';
                setTimeout(function() {
                    btn.textContent = 'Copy Code to Clipboard';
                }, 2000);
            });
        });
    </script>

      <footer>
    <small>
      Copyright © 2025 khushiatcode
    </small>
  </footer>
</body>
</html>
